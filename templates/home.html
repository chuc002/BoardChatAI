<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Forever Board Member ‚Äî MVP</title>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      body { font-family: system-ui, sans-serif; max-width: 950px; margin: 32px auto; color:#111 }
      h2 { margin-bottom: 4px }
      .muted { color:#666; font-size:14px }
      .row { display:flex; gap:12px; align-items:center }
      button { padding:8px 12px; border-radius:8px; border:1px solid #ddd; background:#0ea5e9; color:#fff; cursor:pointer }
      button.secondary { background:#f3f4f6; color:#111; border:1px solid #e5e7eb }
      .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; margin:14px 0 }
      .doc-row { padding:8px 10px; border:1px solid #eee; border-radius:8px; margin:6px 0; background:#fafafa }
      .drop { border:2px dashed #cbd5e1; padding:18px; border-radius:12px; text-align:center; background:#f8fafc }
      #answer { background:#fff; }
      ol { padding-left: 22px }
      sup a { text-decoration:none }
      .small { font-size: 13px; color:#4b5563 }
    </style>
  </head>
  <body>
    <h2>Forever Board Member ‚Äî MVP</h2>
    <div class="muted">Upload board documents and ask questions about their content with AI-powered citations.</div>

    <div class="card">
      <h3>1) Upload documents</h3>
      <div id="drop" class="drop">Drag & drop PDFs here (or use the file picker)</div>
      <form id="upform" class="row" hx-post="/upload" hx-encoding="multipart/form-data" hx-target="#upres" hx-swap="afterend">
        <input id="file" type="file" name="file" multiple accept="application/pdf" />
        <button>Upload</button>
      </form>
      <div id="upres" class="small"></div>
      <script>
        // basic drag&drop to the hidden input
        const dz = document.getElementById('drop');
        const fi = document.getElementById('file');
        dz.addEventListener('dragover', e => { e.preventDefault(); dz.style.background = '#eef6ff'; });
        dz.addEventListener('dragleave', e => { dz.style.background = '#f8fafc'; });
        dz.addEventListener('drop', e => {
          e.preventDefault(); dz.style.background = '#f8fafc';
          fi.files = e.dataTransfer.files;
        });
      </script>
    </div>

    <div class="card">
      <h3>2) Manage documents</h3>
      <div class="row">
        <button class="secondary" hx-get="/docs" hx-target="#docs">Refresh Documents</button>
        <button class="secondary" hx-post="/docs/delete_all" hx-target="#docs">Delete All</button>
      </div>
      <div id="docs" class="small">No docs yet.</div>
    </div>

    <div class="card">
      <h3>3) Ask a question</h3>
      <form class="row" hx-post="/chat" hx-target="#answer" hx-trigger="submit">
        <input type="text" name="q" placeholder="e.g., What are the reserved periods of play?" style="flex:1; padding:10px; border:1px solid #e5e7eb; border-radius:8px"/>
        <button>Ask</button>
      </form>
      <div id="answer" class="card"></div>
    </div>

    <div class="card">
      <h3>4) Recent answers</h3>
      <button class="secondary" hx-get="/history" hx-target="#hist">Refresh</button>
      <div id="hist" class="small">No history yet.</div>
    </div>

    <script>
      function renderAnswer(json){
        let text = (json.markdown || json.answer || '');
        // strip any backend "Sources" block if present
        text = text.replace(/\n-{3,}\n\*\*Sources\*\*:[\s\S]*$/,'').trim();

        // Convert [Doc:..#Chunk:..] to footnote numbers linking to sources below
        const map = new Map(); let idx = 1;
        text = text.replace(/\[Doc:([a-f0-9-]+)#Chunk:(\d+)\]/g, (_, d, c) => {
          const k = d+'#'+c; if (!map.has(k)) map.set(k, idx++); const n = map.get(k);
          return `<sup><a href="#src-${d}-${c}">[${n}]</a></sup>`;
        });

        const html = marked.parse(text);
        const items = [];
        const seen = new Set();
        for (const [k, n] of map.entries()){
          if (seen.has(k)) continue; seen.add(k);
          const [d,c] = k.split('#');
          const meta = (json.citations||[]).find(x => x.document_id===d && String(x.chunk_index)===String(c)) || {};
          const title = meta.title || d;
          const pageTxt = (meta.page_index != null) ? ` (p. ${Number(meta.page_index)+1})` : '';
          const url = meta.url ? `<a href="${meta.url}" target="_blank">open</a>` : '';
          items.push(`<li id="src-${d}-${c}">[${n}] ${title}${pageTxt} ‚Äî ${url}</li>`);
        }
        const sources = items.length ? `<hr/><strong>Sources</strong><ol>${items.join('')}</ol>` : '';
        document.getElementById('answer').innerHTML = html + sources;
      }

      function renameDoc(docId, currentTitle) {
        const newTitle = prompt('New title:', currentTitle);
        if (!newTitle) return;
        htmx.ajax('POST', '/docs/rename', {
          target: '#docs',
          values: { id: docId, title: newTitle }
        });
      }

      document.body.addEventListener('htmx:afterSwap', (e) => {
        // Upload response
        if (e.detail && e.detail.elt && e.detail.elt.id === 'upres') {
          try {
            const json = JSON.parse(e.detail.xhr.responseText);
            if (json.ok) {
              const rows = (json.results||[]).map(r => `‚úì ${r.title} ‚Äî chunks: ${r.chunks}`).join('<br/>');
              e.detail.elt.innerHTML = rows || 'Uploaded.';
              htmx.ajax('GET', '/docs', '#docs');
            }
          } catch(_) {}
        }
        // Docs list
        if (e.detail && e.detail.elt && e.detail.elt.id === 'docs') {
          try {
            const json = JSON.parse(e.detail.xhr.responseText);
            if (json.ok) {
              const rows = (json.docs||[]).map(d => `
                <div class="doc-row">
                  üìÑ <strong>${d.title||d.filename||d.id}</strong> ‚Äî ${d.status}
                  ${d.download?` ¬∑ <a href="${d.download}" target="_blank">open</a>`:''}
                  ¬∑ <button onclick="renameDoc('${d.id}', '${(d.title||d.filename||d.id).replace(/'/g,'\\\'').replace(/"/g,'&quot;')}')">Rename</button>
                  ¬∑ <button hx-post="/docs/delete" hx-target="#docs" hx-vals='{"id":"${d.id}"}' hx-swap="outerHTML">Delete</button>
                </div>`).join('');
              e.detail.elt.innerHTML = rows || 'No docs yet.';
            }
          } catch(_) {}
        }
        // Chat answer
        if (e.detail && e.detail.elt && e.detail.elt.id === 'answer') {
          try { 
            const json = JSON.parse(e.detail.xhr.responseText); 
            if (json.ok) {
              renderAnswer(json);
              // refresh history after each answer
              htmx.ajax('GET', '/history', '#hist');
            } else {
              e.detail.elt.innerHTML = `<div style="color:#dc2626; padding:12px; border:1px solid #fecaca; background:#fef2f2; border-radius:8px">‚ùå ${json.error || 'Error processing question'}</div>`;
            }
          } catch(_) {
            e.detail.elt.innerHTML = '<div style="color:#dc2626; padding:12px; border:1px solid #fecaca; background:#fef2f2; border-radius:8px">‚ùå Error processing request</div>';
          }
        }
        // History
        if (e.detail && e.detail.elt && e.detail.elt.id === 'hist') {
          try {
            const json = JSON.parse(e.detail.xhr.responseText);
            if (json.ok) {
              const rows = (json.items||[]).map(i => `
                <div class="doc-row">
                  <div><strong>Q:</strong> ${i.question}</div>
                  <div class="small">${new Date(i.created_at).toLocaleString()}</div>
                </div>`).join('');
              e.detail.elt.innerHTML = rows || 'No history yet.';
            }
          } catch(_) {}
        }
      });
    </script>
  </body>
</html>