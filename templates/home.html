<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Board Continuity MVP</title>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      body { font-family: system-ui, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; }
      .row { display:flex; gap:12px; align-items:center; margin-bottom: 20px; }
      input[type="text"]{ width: 70%; padding:8px; border: 1px solid #ddd; border-radius: 4px; }
      input[type="file"]{ padding:4px; }
      button{ padding:8px 12px; background: #007acc; color: white; border: none; border-radius: 4px; cursor: pointer; }
      button:hover { background: #005aa3; }
      pre{ white-space:pre-wrap; background:#f6f6f6; padding:12px; border-radius:8px; border: 1px solid #ddd; }
      .answer-box { background: white; padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin-top: 10px; line-height: 1.6; }
      .answer-box h4 { margin-top: 0; color: #333; }
      .answer-box a { color: #007acc; text-decoration: none; }
      .answer-box a:hover { text-decoration: underline; }
      .answer-box hr { border: none; border-top: 1px solid #eee; margin: 20px 0; }
      .answer-box ul { margin: 10px 0; padding-left: 20px; }
      .answer-box li { margin: 5px 0; }
      .loading { color: #666; font-style: italic; }
      .docs-list { background: #f9f9f9; padding: 15px; border-radius: 8px; margin: 10px 0; }
      .doc-item { margin: 10px 0; padding: 10px; background: white; border-radius: 4px; border: 1px solid #ddd; }
      .doc-item button { margin-left: 10px; background: #dc3545; font-size: 12px; padding: 4px 8px; }
      .doc-item button:hover { background: #c82333; }
    </style>
  </head>
  <body>
    <h2>Forever Board Member â€” MVP</h2>
    <p>Upload board documents and ask questions about their content with AI-powered citations.</p>

    <h3>1) Upload a document</h3>
    <form class="row" hx-post="/upload" hx-encoding="multipart/form-data" hx-target="#upres">
      <input type="file" name="file" accept=".pdf" required />
      <button>Upload</button>
    </form>
    <pre id="upres"></pre>

    <h3>2) Manage documents</h3>
    <div class="row">
      <button hx-get="/docs" hx-target="#docs">Refresh Documents</button>
    </div>
    <div id="docs"></div>

    <h3>3) Ask a question</h3>
    <form class="row" hx-post="/chat" hx-target="#answer" hx-trigger="submit">
      <input type="text" name="q" placeholder="e.g., What are the Open Times and Reserved Periods of Play?" />
      <button>Ask</button>
    </form>
    <div id="answer"></div>

    <script>
      // Handle markdown rendering for chat responses
      document.body.addEventListener('htmx:beforeSwap', function(event) {
        if (event.target.id === 'answer') {
          try {
            const response = JSON.parse(event.detail.xhr.responseText);
            if (response.ok && response.markdown) {
              let html = marked.parse(response.markdown);
              
              // Build deduplicated sources section
              if (response.citations && response.citations.length > 0) {
                const byDoc = {};
                response.citations.forEach(c => {
                  if (!byDoc[c.document_id]) byDoc[c.document_id] = [];
                  byDoc[c.document_id].push(c);
                });
                
                const sourceLines = ['<hr>', '<p><strong>Sources:</strong></p>', '<ul>'];
                let count = 0;
                for (const [docId, items] of Object.entries(byDoc)) {
                  if (count >= 6) break;
                  items.sort((a, b) => (a.chunk_index || 0) - (b.chunk_index || 0));
                  const first = items[0];
                  const label = first.title || docId;
                  if (first.url) {
                    sourceLines.push(`<li>${label} â€” <a href="${first.url}" target="_blank">open</a></li>`);
                  } else {
                    sourceLines.push(`<li>${label}</li>`);
                  }
                  count++;
                }
                sourceLines.push('</ul>');
                html += sourceLines.join('\n');
              }
              
              event.detail.serverResponse = '<div class="answer-box">' + html + '</div>';
            } else {
              event.detail.serverResponse = '<div class="answer-box"><p>Error: ' + (response.error || 'Unknown error') + '</p></div>';
            }
          } catch (e) {
            event.detail.serverResponse = '<div class="answer-box"><p>Error parsing response</p></div>';
          }
        }
      });

      // Clear answer when new question is submitted
      document.body.addEventListener('htmx:beforeRequest', function(event) {
        if (event.target.closest('form') && event.target.closest('form').querySelector('input[name="q"]')) {
          document.getElementById('answer').innerHTML = '<div class="answer-box">Thinking...</div>';
        }
      });

      // Handle documents list rendering
      document.body.addEventListener('htmx:beforeSwap', function(event) {
        if (event.target.id === 'docs') {
          try {
            const json = JSON.parse(event.detail.xhr.responseText);
            if (json.ok && json.docs) {
              const rows = (json.docs||[]).map(d => `
                <div class="doc-item">
                  ðŸ“„ <strong>${d.title||d.filename||d.id}</strong> â€” ${d.status}
                  ${d.download?`Â· <a href="${d.download}" target="_blank">open</a>`:''}
                  Â· <button hx-post="/docs/delete" hx-target="#docs" hx-vals='{"id":"${d.id}"}' hx-swap="outerHTML">Delete</button>
                </div>`).join('');
              event.detail.serverResponse = '<div class="docs-list">' + (rows || '<p>No documents uploaded yet.</p>') + '</div>';
            } else {
              event.detail.serverResponse = '<div class="docs-list"><p>Error loading documents</p></div>';
            }
          } catch (e) {
            event.detail.serverResponse = '<div class="docs-list"><p>Error parsing documents response</p></div>';
          }
        }
      });
    </script>
  </body>
</html>