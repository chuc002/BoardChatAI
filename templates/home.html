<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Board Continuity MVP</title>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      body { font-family: system-ui, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; }
      .row { display:flex; gap:12px; align-items:center; margin-bottom: 20px; }
      input[type="text"]{ width: 70%; padding:8px; border: 1px solid #ddd; border-radius: 4px; }
      input[type="file"]{ padding:4px; }
      button{ padding:8px 12px; background: #007acc; color: white; border: none; border-radius: 4px; cursor: pointer; }
      button:hover { background: #005aa3; }
      pre{ white-space:pre-wrap; background:#f6f6f6; padding:12px; border-radius:8px; border: 1px solid #ddd; }
      .answer-box { background: white; padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin-top: 10px; line-height: 1.6; }
      .answer-box h4 { margin-top: 0; color: #333; }
      .answer-box a { color: #007acc; text-decoration: none; }
      .answer-box a:hover { text-decoration: underline; }
      .answer-box hr { border: none; border-top: 1px solid #eee; margin: 20px 0; }
      .answer-box ul { margin: 10px 0; padding-left: 20px; }
      .answer-box li { margin: 5px 0; }
      .loading { color: #666; font-style: italic; }
      .docs-list { background: #f9f9f9; padding: 15px; border-radius: 8px; margin: 10px 0; }
      .doc-row { margin: 10px 0; padding: 10px; background: white; border-radius: 4px; border: 1px solid #ddd; }
      .doc-row button { margin-left: 10px; background: #dc3545; font-size: 12px; padding: 4px 8px; }
      .doc-row button:hover { background: #c82333; }
      .answer-box sup a { text-decoration: none; color: #007acc; font-weight: bold; }
      .answer-box sup a:hover { text-decoration: underline; }
      .answer-box ol { padding-left: 20px; }
      .answer-box ol li { margin: 5px 0; }
    </style>
  </head>
  <body>
    <h2>Forever Board Member â€” MVP</h2>
    <p>Upload board documents and ask questions about their content with AI-powered citations.</p>

    <h3>1) Upload a document</h3>
    <form class="row" hx-post="/upload" hx-encoding="multipart/form-data" hx-target="#upres">
      <input type="file" name="file" accept=".pdf" required />
      <button>Upload</button>
    </form>
    <pre id="upres"></pre>

    <h3>2) Manage documents</h3>
    <div class="row">
      <button hx-get="/docs" hx-target="#docs">Refresh Documents</button>
      <button hx-post="/docs/delete_all" hx-target="#docs" hx-confirm="Delete ALL documents? This cannot be undone." style="background: #dc3545;">Delete All</button>
    </div>
    <div id="docs"></div>

    <h3>3) Ask a question</h3>
    <form class="row" hx-post="/chat" hx-target="#answer" hx-trigger="submit">
      <input type="text" name="q" placeholder="e.g., What are the Open Times and Reserved Periods of Play?" />
      <button>Ask</button>
    </form>
    <div id="answer"></div>

    <script>
      // Render markdown + numbered citations + clean Sources list
      function renderAnswer(json){
        let text = (json.markdown || json.answer || '');
        // strip any backend "Sources" block if present
        text = text.replace(/\n-{3,}\n\*\*Sources\*\*:[\s\S]*$/,'').trim();

        // Map [Doc:..#Chunk:..] -> [Â¹] superscripts linking to sources below
        const map = new Map(); // key = "doc#chunk" -> index
        let idx = 1;
        text = text.replace(/\[Doc:([a-f0-9-]+)#Chunk:(\d+)\]/g, (_, d, c) => {
          const key = d + '#' + c;
          if (!map.has(key)) map.set(key, idx++);
          const n = map.get(key);
          return `<sup><a href="#src-${d}-${c}">[${n}]</a></sup>`;
        });

        // Render main body
        const html = marked.parse(text);

        // Build deduped sources list (only for pairs actually cited)
        const items = [];
        const seen = new Set();
        for (const [key, n] of map.entries()) {
          if (seen.has(key)) continue;
          seen.add(key);
          const [d, c] = key.split('#');
          const meta = (json.citations||[]).find(x => x.document_id === d && String(x.chunk_index) === String(c)) || {};
          const title = meta.title || d;
          const url = meta.url ? `<a href="${meta.url}" target="_blank">open</a>` : '';
          items.push(`<li id="src-${d}-${c}">[${n}] ${title} (chunk ${c}) â€” ${url}</li>`);
        }
        const sourcesHtml = items.length ? `<hr/><strong>Sources</strong><ol>${items.join('')}</ol>` : '';

        const box = document.getElementById('answer');
        box.innerHTML = html + sourcesHtml;
      }

      document.body.addEventListener('htmx:afterSwap', (e) => {
        // Chat response
        if (e.detail && e.detail.elt && e.detail.elt.id === 'answer') {
          try {
            const json = JSON.parse(e.detail.xhr.responseText);
            if (json.ok) renderAnswer(json);
          } catch(_) {}
        }
        // Docs list response
        if (e.detail && e.detail.elt && e.detail.elt.id === 'docs') {
          try {
            const json = JSON.parse(e.detail.xhr.responseText);
            if (json.ok) {
              const rows = (json.docs||[]).map(d => `
                <div class="doc-row">
                  ðŸ“„ <strong>${d.title||d.filename||d.id}</strong> â€” ${d.status}
                  ${d.download?` Â· <a href="${d.download}" target="_blank">open</a>`:''}
                  Â· <button hx-post="/docs/delete" hx-target="#docs" hx-vals='{"id":"${d.id}"}' hx-swap="outerHTML">Delete</button>
                </div>`).join('');
              e.detail.elt.innerHTML = rows || 'No docs yet.';
            }
          } catch(_) {}
        }
      });

      // Clear answer when new question is submitted
      document.body.addEventListener('htmx:beforeRequest', function(event) {
        if (event.target.closest('form') && event.target.closest('form').querySelector('input[name="q"]')) {
          document.getElementById('answer').innerHTML = '<div class="answer-box">Thinking...</div>';
        }
      });
    </script>
  </body>
</html>